#!/usr/bin/env ruby

require './lib/boot'

$logger.debug 'Starting checker'

tasks_by_subdomain = Task.active.group(:subdomain).count

tasks_by_subdomain.each do |subdomain, count|
  $logger.info "subdomain: #{subdomain} count: #{count}"

  task = Task.active.where(subdomain: subdomain).order(created_at: :desc).first
  $logger.info "[Process task] #{task.inspect}"
  task.start! if task.created?

  task_log_file_path = "/files/logs/#{task.id}.log"
  FileUtils.touch task_log_file_path
  pid = spawn("bin/run_task #{task.id.to_s} >> #{task_log_file_path} 2>&1")
  $logger.info "keep going in ##{pid} process..."
end
